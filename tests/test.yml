---
- name: Install components
  hosts: all
  roles:
    - role: ../roles/fluent-bit
    - role: ../roles/loki
    - role: ../roles/traefik
    - role: ../roles/cadvisor
    - role: ../roles/prometheus
    - role: ../roles/grafana
    - role: ../roles/nextcloud
    - role: ../roles/matomo
      tags: [ 'matomo', 'matomo-install' ]

  pre_tasks:
    - name: Update /etc/hosts
      become: yes
      lineinfile:
        path: /etc/hosts
        regexp: "{{ item }}"
        line: "127.0.0.1 {{ item }}"
      with_items:
        - "{{ traefik_hostname }}"
        - "{{ prometheus_hostname }}"
        - "{{ grafana_hostname }}"
        - "{{ nextcloud_hostname }}"
        - "{{ matomo_hostname }}"

    - name: Create docker networks
      become: yes
      docker_network:
        name: "{{ test_docker_network }}"

  tasks:
    # - name: Run containers
    #   become: yes
    #   docker_compose:
    #     project_src: "{{ item }}"
    #     restarted: yes
    #   loop:
    #     - "{{ fluent_bit_install_path }}"
    #     - "{{ loki_install_path }}"
    #     - "{{ traefik_install_path }}"
    #     - "{{ cadvisor_install_path }}"
    #     - "{{ prometheus_install_path }}"
    #     - "{{ grafana_install_path }}"

    # - name: Run Nextcloud DB
    #   become: yes
    #   docker_compose:
    #     project_src: "{{ nextcloud_install_path }}"
    #     services: [ 'nextcloud-db', 'nextcloud-redis' ]

    # - name: Wait for Nextcloud DB is healthy
    #   become: yes
    #   shell:
    #     chdir: "{{ nextcloud_install_path }}"
    #     cmd: docker-compose ps nextcloud-db | grep "(healthy)"
    #   register: cmd_res
    #   retries: 20
    #   delay: 15
    #   until: cmd_res.rc == 0

    # - name: Run Nextcloud
    #   become: yes
    #   docker_compose:
    #     project_src: "{{ nextcloud_install_path }}"
    #     services: [ 'nextcloud' ]

    # - name: Run Matomo DB
    #   become: yes
    #   docker_compose:
    #     project_src: "{{ matomo_install_path }}"
    #     services: [ 'matomo-db' ]

    # - name: Wait for Matomo DB is healthy
    #   become: yes
    #   shell:
    #     chdir: "{{ matomo_install_path }}"
    #     cmd: docker-compose ps matomo-db | grep "(healthy)"
    #   register: cmd_res
    #   retries: 20
    #   delay: 15
    #   until: cmd_res.rc == 0

    # - name: Run Matomo
    #   become: yes
    #   docker_compose:
    #     project_src: "{{ matomo_install_path }}"
    #     services: [ 'matomo' ]

- name: Test fluent-bit
  import_playbook: test-fluent-bit.yml

- name: Test Loki
  import_playbook: test-loki.yml

- name: Test cAdvisor
  import_playbook: test-cadvisor.yml

- name: Test Prometheus
  import_playbook: test-prometheus.yml

- name: Test Grafana
  import_playbook: test-grafana.yml

- name: Test Traefik
  import_playbook: test-traefik.yml

- name: Test Nextcloud
  import_playbook: test-nextcloud.yml

- name: Test Matomo
  import_playbook: test-matomo.yml

# - name: Stop test
#   import_playbook: test-end.yml
